syntax = "proto3";

package echo.v1;

import "buf/validate/validate.proto";
import "echo/v1/common.proto";
import "google/protobuf/timestamp.proto";

option go_package = "buf.build/gen/go/echo-tracker/echo/protocolbuffers/go/echo/v1;echov1";

// PlanService manages user financial plans
service PlanService {
  // CreatePlan creates a new financial plan
  rpc CreatePlan(CreatePlanRequest) returns (CreatePlanResponse);

  // GetPlan retrieves a plan by ID
  rpc GetPlan(GetPlanRequest) returns (GetPlanResponse);

  // ListPlans lists all plans for the current user
  rpc ListPlans(ListPlansRequest) returns (ListPlansResponse);

  // UpdatePlan updates an existing plan
  rpc UpdatePlan(UpdatePlanRequest) returns (UpdatePlanResponse);

  // DeletePlan soft-deletes a plan
  rpc DeletePlan(DeletePlanRequest) returns (DeletePlanResponse);

  // UpdatePlanStructure updates the entire structure of a plan (categories, items, etc.)
  rpc UpdatePlanStructure(UpdatePlanStructureRequest) returns (UpdatePlanStructureResponse);

  // SetActivePlan marks a plan as the active/live plan
  rpc SetActivePlan(SetActivePlanRequest) returns (SetActivePlanResponse);

  // DuplicatePlan creates a copy of an existing plan
  rpc DuplicatePlan(DuplicatePlanRequest) returns (DuplicatePlanResponse);

  // ImportPlanFromExcel imports a plan from an uploaded Excel file
  rpc ImportPlanFromExcel(ImportPlanFromExcelRequest) returns (ImportPlanFromExcelResponse);

  // AnalyzeExcelForPlan analyzes an Excel file to determine structure
  rpc AnalyzeExcelForPlan(AnalyzeExcelForPlanRequest) returns (AnalyzeExcelForPlanResponse);

  // ComputePlanActuals syncs actual spending from transactions to plan items
  rpc ComputePlanActuals(ComputePlanActualsRequest) returns (ComputePlanActualsResponse);

  // ============= Item Config Management =============
  // User-configurable item types (Budget, Recurring, Income, etc.)
  
  // ListItemConfigs returns all item configs for the current user
  rpc ListItemConfigs(ListItemConfigsRequest) returns (ListItemConfigsResponse);
  
  // CreateItemConfig creates a new custom item type
  rpc CreateItemConfig(CreateItemConfigRequest) returns (CreateItemConfigResponse);
  
  // UpdateItemConfig updates an existing item config
  rpc UpdateItemConfig(UpdateItemConfigRequest) returns (UpdateItemConfigResponse);
  
  // DeleteItemConfig deletes a custom item config (system configs cannot be deleted)
  rpc DeleteItemConfig(DeleteItemConfigRequest) returns (DeleteItemConfigResponse);
  
  // ============= Budget Period Management =============
  // Monthly budget versioning - each month can have different values
  
  // GetBudgetPeriod gets or creates a budget period for a specific month
  rpc GetBudgetPeriod(GetBudgetPeriodRequest) returns (GetBudgetPeriodResponse);
  
  // ListBudgetPeriods lists all budget periods for a plan
  rpc ListBudgetPeriods(ListBudgetPeriodsRequest) returns (ListBudgetPeriodsResponse);
  
  // UpdateBudgetPeriodItem updates a specific item's values for a period
  rpc UpdateBudgetPeriodItem(UpdateBudgetPeriodItemRequest) returns (UpdateBudgetPeriodItemResponse);
  
  // CopyBudgetPeriod copies values from one period to another
  rpc CopyBudgetPeriod(CopyBudgetPeriodRequest) returns (CopyBudgetPeriodResponse);
  
  // ============= Filtered Item Queries =============
  // Query items by target tab for Goals/Budgets/Recurring views
  
  // GetPlanItemsByTab returns items filtered by target tab
  rpc GetPlanItemsByTab(GetPlanItemsByTabRequest) returns (GetPlanItemsByTabResponse);
}

// Plan source types
enum PlanSourceType {
  PLAN_SOURCE_TYPE_UNSPECIFIED = 0;
  PLAN_SOURCE_TYPE_MANUAL = 1;
  PLAN_SOURCE_TYPE_EXCEL = 2;
  PLAN_SOURCE_TYPE_TEMPLATE = 3;
}

// Plan status
enum PlanStatus {
  PLAN_STATUS_UNSPECIFIED = 0;
  PLAN_STATUS_DRAFT = 1;
  PLAN_STATUS_ACTIVE = 2;
  PLAN_STATUS_ARCHIVED = 3;
}

// Widget types for plan items
enum WidgetType {
  WIDGET_TYPE_UNSPECIFIED = 0;
  WIDGET_TYPE_INPUT = 1;
  WIDGET_TYPE_SLIDER = 2;
  WIDGET_TYPE_TOGGLE = 3;
  WIDGET_TYPE_READONLY = 4;
}

// Field types for plan items
enum FieldType {
  FIELD_TYPE_UNSPECIFIED = 0;
  FIELD_TYPE_CURRENCY = 1;
  FIELD_TYPE_PERCENTAGE = 2;
  FIELD_TYPE_NUMBER = 3;
  FIELD_TYPE_TEXT = 4;
}

// Item types for plan items - determines which tab displays this item
enum ItemType {
  ITEM_TYPE_UNSPECIFIED = 0;
  ITEM_TYPE_BUDGET = 1;      // Regular expense tracked in Budgets tab
  ITEM_TYPE_RECURRING = 2;   // Subscription tracked in Recurring tab  
  ITEM_TYPE_GOAL = 3;        // Savings target tracked in Goals tab
  ITEM_TYPE_INCOME = 4;      // Income source
}

// Behavior types for mathematical logic (dynamic configs)
enum ItemBehavior {
  ITEM_BEHAVIOR_UNSPECIFIED = 0;
  ITEM_BEHAVIOR_OUTFLOW = 1;    // Reduces surplus (expenses)
  ITEM_BEHAVIOR_INFLOW = 2;     // Adds to surplus (income)
  ITEM_BEHAVIOR_ASSET = 3;      // Tracked on balance sheet (+)
  ITEM_BEHAVIOR_LIABILITY = 4;  // Tracked on balance sheet (-)
}

// Target tabs where items appear in the UI
enum TargetTab {
  TARGET_TAB_UNSPECIFIED = 0;
  TARGET_TAB_BUDGETS = 1;
  TARGET_TAB_RECURRING = 2;
  TARGET_TAB_GOALS = 3;
  TARGET_TAB_INCOME = 4;
  TARGET_TAB_PORTFOLIO = 5;
  TARGET_TAB_LIABILITIES = 6;
}

// UserPlan represents a user's financial plan
message UserPlan {
  string id = 1;
  string name = 2;
  string description = 3;
  PlanStatus status = 4;
  PlanSourceType source_type = 5;

  // Excel source metadata
  string source_file_id = 6;
  string excel_sheet_name = 7;

  // Summary amounts
  Money total_income = 8;
  Money total_expenses = 9;
  Money surplus = 10;

  // Plan structure
  repeated PlanCategoryGroup category_groups = 11;

  // Configuration
  PlanConfig config = 12;

  google.protobuf.Timestamp created_at = 13;
  google.protobuf.Timestamp updated_at = 14;
}

// PlanCategoryGroup represents a high-level grouping (e.g., Fundamentals, Fun, Future)
message PlanCategoryGroup {
  string id = 1;
  string name = 2;
  string color = 3;  // Hex color
  double target_percent = 4;  // Target allocation percentage
  repeated PlanCategory categories = 5;
  
  // i18n labels
  map<string, string> labels = 6;
}

// PlanCategory represents a spending/income category within a plan
message PlanCategory {
  string id = 1;
  string name = 2;
  string icon = 3;
  string color = 4;
  int32 sort_order = 5;
  repeated PlanItem items = 6;

  // Aggregated totals
  Money budgeted_total = 7;
  Money actual_total = 8;

  // i18n labels
  map<string, string> labels = 9;
}

// PlanItem represents a single budget line item
message PlanItem {
  string id = 1;
  string name = 2;
  
  // Amounts (in minor units)
  Money budgeted = 3;
  Money actual = 4;
  
  // Excel mapping
  string excel_cell = 5;
  string formula = 6;
  
  // UI configuration
  WidgetType widget_type = 7;
  FieldType field_type = 8;
  int32 sort_order = 9;

  // Value constraints
  int64 min_value = 10;
  int64 max_value = 11;

  // i18n labels
  map<string, string> labels = 12;

  // Item type - determines which tab this item appears in
  ItemType item_type = 13;

  // Link to recurring subscription (for auto-synced subscriptions)
  optional string recurring_subscription_id = 14;

  // Link to goal (for savings targets)
  optional string goal_id = 15;

  // Dynamic config reference (replaces item_type for configurable types)
  optional string config_id = 16;
}

// PlanConfig holds plan-level configuration
message PlanConfig {
  string chart_type = 1;  // horizontal_bar, pie, etc.
  bool show_percentages = 2;
  string currency_code = 3;
  
  // Formula mappings for computed fields
  map<string, string> formula_mappings = 4;
}

// ============================================================================
// Request/Response Messages
// ============================================================================

message CreatePlanRequest {
  string name = 1 [(buf.validate.field).string.min_len = 1];
  string description = 2;
  string currency_code = 3;
  repeated CreateCategoryGroupInput category_groups = 4;
}

message CreateCategoryGroupInput {
  optional string id = 6; // Optional ID for updates
  string name = 1 [(buf.validate.field).string.min_len = 1];
  string color = 2;
  double target_percent = 3;
  repeated CreateCategoryInput categories = 4;
  map<string, string> labels = 5;
}

message CreateCategoryInput {
  optional string id = 5; // Optional ID for updates
  string name = 1 [(buf.validate.field).string.min_len = 1];
  string icon = 2;
  repeated CreateItemInput items = 3;
  map<string, string> labels = 4;
}

message CreateItemInput {
  optional string id = 9; // Optional ID for updates
  string name = 1 [(buf.validate.field).string.min_len = 1];
  int64 budgeted_minor = 2;
  WidgetType widget_type = 3;
  FieldType field_type = 4;
  map<string, string> labels = 5;
  ItemType item_type = 6;  // What tab this item appears in (legacy)
  optional string config_id = 7;  // Dynamic config reference (preferred)
  optional int64 initial_actual_minor = 8; // Initial "Saved" amount for goals or starting balance
}

message CreatePlanResponse {
  UserPlan plan = 1;
}

message GetPlanRequest {
  string plan_id = 1 [(buf.validate.field).string.uuid = true];
}

message GetPlanResponse {
  UserPlan plan = 1;
}

message ListPlansRequest {
  PlanStatus status_filter = 1;
  int32 limit = 2;
  int32 offset = 3;
}

message ListPlansResponse {
  repeated UserPlan plans = 1;
  int32 total_count = 2;
}

message UpdatePlanRequest {
  string plan_id = 1 [(buf.validate.field).string.uuid = true];
  optional string name = 2;
  optional string description = 3;
  repeated UpdateItemInput items = 4;
}

message UpdateItemInput {
  string item_id = 1 [(buf.validate.field).string.uuid = true];
  int64 budgeted_minor = 2;
}

message UpdatePlanResponse {
  UserPlan plan = 1;
}

message UpdatePlanStructureRequest {
  string plan_id = 1 [(buf.validate.field).string.uuid = true];
  repeated CreateCategoryGroupInput category_groups = 2; // Re-use create input as it defines the full structure
}

message UpdatePlanStructureResponse {
  UserPlan plan = 1;
}

message DeletePlanRequest {
  string plan_id = 1 [(buf.validate.field).string.uuid = true];
}

message DeletePlanResponse {}

message SetActivePlanRequest {
  string plan_id = 1 [(buf.validate.field).string.uuid = true];
}

message SetActivePlanResponse {
  UserPlan plan = 1;
}

message DuplicatePlanRequest {
  string plan_id = 1 [(buf.validate.field).string.uuid = true];
  string new_name = 2 [(buf.validate.field).string.min_len = 1];
}

message DuplicatePlanResponse {
  UserPlan plan = 1;
}

message ImportPlanFromExcelRequest {
  string file_id = 1 [(buf.validate.field).string.uuid = true];
  string sheet_name = 2;
  ExcelMappingConfig mapping = 3;
}

message ExcelMappingConfig {
  string category_column = 1;  // e.g., "A"
  string value_column = 2;     // e.g., "B"
  int32 header_row = 3;        // Row number where headers start
  bool has_percentage_column = 4;
  string percentage_column = 5;
  string start_cell = 6;       // Optional: specific cell coordinate like "B10"
}

message ImportPlanFromExcelResponse {
  UserPlan plan = 1;
  int32 categories_imported = 2;
  int32 items_imported = 3;
}

message AnalyzeExcelForPlanRequest {
  string file_id = 1 [(buf.validate.field).string.uuid = true];
}

message AnalyzeExcelForPlanResponse {
  repeated ExcelSheetAnalysis sheets = 1;
  string suggested_sheet = 2;
}

message ExcelSheetAnalysis {
  string name = 1;
  bool is_living_plan = 2;  // Has formulas
  int32 row_count = 3;
  int32 formula_count = 4;
  repeated string detected_categories = 5;
  repeated string month_columns = 6;  // e.g., ["jan-26", "feb-26"]
  DetectedColumnMapping detected_mapping = 7; // Auto-detected column layout
  repeated ExcelPreviewRow preview_rows = 8; // First 5 rows for preview
}

// ExcelPreviewRow represents a single row of preview data
message ExcelPreviewRow {
  repeated string cells = 1;  // Cell values for this row
}

// DetectedColumnMapping contains auto-detected column positions for import
message DetectedColumnMapping {
  string category_column = 1;   // Detected column for categories (e.g., "A")
  string value_column = 2;      // Detected column for values (e.g., "C")
  int32 header_row = 3;         // Detected header row (1-indexed)
  string percentage_column = 4; // Detected column for percentages (optional)
  double confidence = 5;        // Detection confidence 0-1 (0.9+ = high confidence)
}

// ComputePlanActuals request - calculates actual spending from transactions
message ComputePlanActualsRequest {
  string plan_id = 1 [(buf.validate.field).string.uuid = true];
  
  // Period for which to compute actuals
  google.protobuf.Timestamp start_date = 2;
  google.protobuf.Timestamp end_date = 3;
  
  // If true, update the plan items with the computed actuals
  bool persist = 4;
}

message ComputePlanActualsResponse {
  // The plan with updated actual values
  UserPlan plan = 1;
  
  // Summary of computation
  int32 items_updated = 2;
  int32 transactions_matched = 3;
  
  // Any items without matching transactions
  repeated UnmatchedItem unmatched_items = 4;
}

message UnmatchedItem {
  string item_id = 1;
  string item_name = 2;
  string reason = 3; // e.g., "no_category_mapping", "no_transactions"
}

// ============= Item Config Messages =============

// ItemConfig represents a user-configurable item type
message ItemConfig {
  string id = 1;
  string label = 2;           // Display name: "Budget", "Investment"
  string short_code = 3;      // Button code: "B", "I", "D"
  ItemBehavior behavior = 4;  // Mathematical behavior
  TargetTab target_tab = 5;   // Which UI tab displays items of this type
  string color_hex = 6;       // Color for UI: "#22c55e"
  string icon = 7;            // Icon name: "wallet", "trending-up"
  bool is_system = 8;         // System defaults cannot be deleted
  int32 sort_order = 9;       // Display order in type selector
}

// ListItemConfigs - returns all configs for current user
message ListItemConfigsRequest {}

message ListItemConfigsResponse {
  repeated ItemConfig configs = 1;
}

// CreateItemConfig - creates a new custom type
message CreateItemConfigRequest {
  string label = 1 [(buf.validate.field).string.min_len = 1];
  string short_code = 2 [(buf.validate.field).string = {min_len: 1, max_len: 3}];
  ItemBehavior behavior = 3;
  TargetTab target_tab = 4;
  string color_hex = 5;
  string icon = 6;
}

message CreateItemConfigResponse {
  ItemConfig config = 1;
}

// UpdateItemConfig - updates an existing config
message UpdateItemConfigRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  optional string label = 2;
  optional string short_code = 3;
  optional ItemBehavior behavior = 4;
  optional TargetTab target_tab = 5;
  optional string color_hex = 6;
  optional string icon = 7;
  optional int32 sort_order = 8;
}

message UpdateItemConfigResponse {
  ItemConfig config = 1;
}

// DeleteItemConfig - deletes a custom config (system configs cannot be deleted)
message DeleteItemConfigRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
}

message DeleteItemConfigResponse {
  bool success = 1;
}

// ============================================================================
// Budget Period Messages
// ============================================================================

// BudgetPeriod - A monthly snapshot of budget values
message BudgetPeriod {
  string id = 1;
  string plan_id = 2;
  int32 year = 3;
  int32 month = 4;
  bool is_locked = 5;
  string notes = 6;
  repeated BudgetPeriodItem items = 7;
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
}

// BudgetPeriodItem - Budget values for an item in a specific period
message BudgetPeriodItem {
  string id = 1;
  string period_id = 2;
  string item_id = 3;
  string item_name = 4;
  string category_name = 5;
  int64 budgeted_minor = 6;
  int64 actual_minor = 7;
  string notes = 8;
}

// GetBudgetPeriod - Gets or creates period for a month
message GetBudgetPeriodRequest {
  string plan_id = 1 [(buf.validate.field).string.uuid = true];
  int32 year = 2 [(buf.validate.field).int32 = {gte: 2000, lte: 2100}];
  int32 month = 3 [(buf.validate.field).int32 = {gte: 1, lte: 12}];
}

message GetBudgetPeriodResponse {
  BudgetPeriod period = 1;
  bool was_created = 2;  // True if a new period was created
}

// ListBudgetPeriods - List all periods for a plan
message ListBudgetPeriodsRequest {
  string plan_id = 1 [(buf.validate.field).string.uuid = true];
}

message ListBudgetPeriodsResponse {
  repeated BudgetPeriod periods = 1;
}

// UpdateBudgetPeriodItem - Update values for a specific item in a period
message UpdateBudgetPeriodItemRequest {
  string period_item_id = 1 [(buf.validate.field).string.uuid = true];
  optional int64 budgeted_minor = 2;
  optional int64 actual_minor = 3;
  optional string notes = 4;
}

message UpdateBudgetPeriodItemResponse {
  BudgetPeriodItem item = 1;
}

// CopyBudgetPeriod - Copy values from one period to another
message CopyBudgetPeriodRequest {
  string source_period_id = 1 [(buf.validate.field).string.uuid = true];
  string target_plan_id = 2 [(buf.validate.field).string.uuid = true];
  int32 target_year = 3 [(buf.validate.field).int32 = {gte: 2000, lte: 2100}];
  int32 target_month = 4 [(buf.validate.field).int32 = {gte: 1, lte: 12}];
}

message CopyBudgetPeriodResponse {
  BudgetPeriod period = 1;
}

// ============================================================================
// Filtered Item Queries
// ============================================================================

// GetPlanItemsByTab - Get items from a plan filtered by target tab
message GetPlanItemsByTabRequest {
  string plan_id = 1 [(buf.validate.field).string.uuid = true];
  TargetTab target_tab = 2;
}

message GetPlanItemsByTabResponse {
  repeated PlanItemWithConfig items = 1;
  Money total_budgeted = 2;
  Money total_actual = 3;
}

// PlanItemWithConfig - Item with its config details for display
message PlanItemWithConfig {
  string id = 1;
  string name = 2;
  Money budgeted = 3;
  Money actual = 4;
  string category_name = 5;
  string group_name = 6;
  
  // Config details
  string config_id = 7;
  string config_label = 8;      // e.g., "Budget", "Recurring"
  string config_short_code = 9; // e.g., "B", "R", "S"
  string config_color_hex = 10;
  ItemBehavior behavior = 11;
}
